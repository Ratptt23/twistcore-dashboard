<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TwistCore Monitor</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:16px;background:#0b0f14;color:#e8eef4}
    h1{font-size:18px;margin:0 0 12px}
    #meta{font-size:12px;opacity:.8;margin-bottom:12px}
    .card{background:#101722;border:1px solid #1b2636;border-radius:14px;padding:14px}
    canvas{width:100%;max-width:100%;height:56vh}
  </style>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

  <!-- Firebase v9 CDN (Modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getDatabase, ref, query, limitToLast, onValue } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    // ▼▼▼ ここをあなたの値に置き換え ▼▼▼
    const firebaseConfig = {
      apiKey: "AIzaSyAnqsz3eyDLv3q6ByUU06qgwtdf1jPH65k",
      authDomain: "mt4signal1-d3b08.firebaseapp.com",
      databaseURL: "https://mt4signal1-d3b08-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "mt4signal1-d3b08",
    };
    // ▲▲▲ ここまで ▲▲▲

    // Firebase init
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // 最新 N 件だけ取得（必要に応じて増減）
    const N = 200;
    const coreRef = query(ref(db, "twistcore_data"), limitToLast(N));

    // Chart 準備
    const ctx = document.getElementById("coreChart").getContext("2d");
    const state = { labels: [], values: [] };

    const chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: state.labels,
        datasets: [{
          label: "TwistCore",
          data: state.values,
          tension: 0.25,
          fill: false,
          pointRadius: 0,
          borderWidth: 2,
        }]
      },
      options: {
        animation: false,
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: { color: "#a7b3c5", maxRotation: 0, autoSkip: true, maxTicksLimit: 8 },
            grid: { color: "rgba(167,179,197,0.08)" }
          },
          y: {
            ticks: { color: "#a7b3c5" },
            grid: { color: "rgba(167,179,197,0.08)" }
          }
        },
        plugins: {
          legend: { labels: { color: "#cfe2ff" } },
          tooltip: { mode: "index", intersect: false }
        }
      }
    });

    // Realtime 監視
    onValue(coreRef, (snap) => {
      const data = snap.val();
      const rows = [];

      if (data) {
        // POSTの自動キー配下に { timestamp, core } が入っている前提
        for (const key of Object.keys(data)) {
          const row = data[key];
          // 防御：欠損や型違いを弾く
          if (!row || typeof row.core === "undefined" || !row.timestamp) continue;
          rows.push({ ts: row.timestamp, core: Number(row.core) });
        }

        // タイムスタンプでソート（文字列でも昇順に近い並びになるが明示しておく）
        rows.sort((a,b) => (a.ts > b.ts ? 1 : -1));

        state.labels.length = 0;
        state.values.length = 0;

        for (const r of rows) {
          state.labels.push(r.ts);
          state.values.push(r.core);
        }

        chart.update();
        document.getElementById("meta").textContent =
          `点数: ${rows.length} / 最終: ${rows.length ? rows[rows.length-1].ts : "-"}`;
      } else {
        state.labels.length = 0;
        state.values.length = 0;
        chart.update();
        document.getElementById("meta").textContent = "データなし";
      }
    });
  </script>
</head>
<body>
  <h1>TwistCore Monitor</h1>
  <div id="meta">準備中…</div>
  <div class="card">
    <canvas id="coreChart"></canvas>
  </div>
</body>
</html>
